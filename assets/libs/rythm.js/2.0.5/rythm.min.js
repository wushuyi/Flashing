!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Rythm=e()}(this,function(){"use strict";var t=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},e=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),n=new function e(){var n=this;t(this,e),this.initialise=function(t){n.analyser=t,n.analyser.fftSize=2048},this.reset=function(){n.hzHistory=[],n.frequences=new Uint8Array(n.analyser.frequencyBinCount)},this.analyse=function(){n.analyser.getByteFrequencyData(n.frequences);for(var t=0;t<n.frequences.length;t++)n.hzHistory[t]||(n.hzHistory[t]=[]),n.hzHistory[t].length>n.maxValueHistory&&n.hzHistory[t].shift(),n.hzHistory[t].push(n.frequences[t])},this.getRangeAverageRatio=function(t,e){for(var i=0,r=t;r<e+t;r++)i+=n.getFrequenceRatio(r);return i/e},this.getFrequenceRatio=function(t){var e=255,i=0;n.hzHistory[t].forEach(function(t){t<e&&(e=t),t>i&&(i=t)});var r=i-e,a=(n.frequences[t]-e)/r;return n.startingScale+n.pulseRatio*a},this.startingScale=0,this.pulseRatio=1,this.maxValueHistory=100,this.hzHistory=[]},i=new function e(){var i=this;t(this,e),this.createSourceFromAudioElement=function(t){t.setAttribute("rythm-connected",i.connectedSources.length);var e=i.audioCtx.createMediaElementSource(t);return i.connectedSources.push(e),e},this.connectExternalAudioElement=function(t){i.audio=t,i.currentInputType=i.inputTypeList.EXTERNAL;var e=t.getAttribute("rythm-connected");i.source=e?i.connectedSources[e]:i.createSourceFromAudioElement(i.audio),i.connectSource(i.source)},this.connectSource=function(t){t.connect(i.gain),i.gain.connect(n.analyser),i.currentInputType!==i.inputTypeList.STREAM&&(n.analyser.connect(i.audioCtx.destination),i.audio.addEventListener("ended",i.stop))},this.setMusic=function(t){i.audio=new Audio(t),i.currentInputType=i.inputTypeList.TRACK,i.source=i.createSourceFromAudioElement(i.audio),i.connectSource(i.source)},this.setGain=function(t){i.gain.gain.value=t},this.plugMicrophone=function(){return i.getMicrophoneStream().then(function(t){i.audio=t,i.currentInputType=i.inputTypeList.STREAM,i.source=i.audioCtx.createMediaStreamSource(t),i.connectSource(i.source)})},this.getMicrophoneStream=function(){return navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,new Promise(function(t,e){navigator.getUserMedia({audio:!0},function(e){return t(e)},function(t){return e(t)})})},this.start=function(){i.currentInputType===i.inputTypeList.TRACK&&i.audio.play()},this.stop=function(){i.currentInputType===i.inputTypeList.TRACK?i.audio.pause():i.currentInputType===i.inputTypeList.STREAM&&(i.audio.getAudioTracks()[0].enabled=!1)},this.browserAudioCtx=AudioContext||webkitAudioContext,this.audioCtx=new this.browserAudioCtx,this.connectedSources=[],n.initialise(this.audioCtx.createAnalyser()),this.gain=this.audioCtx.createGain(),this.source={},this.audio={},this.hzHistory=[],this.inputTypeList={TRACK:0,STREAM:1,EXTERNAL:2}},r=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=isNaN(n.max)?1.25:n.max,r=isNaN(n.min)?.75:n.min,a=(i-r)*e;t.style.transform="scale("+(r+a)+")"},a=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=isNaN(n.max)?15:n.max,r=isNaN(n.min)?-15:n.min;"left"===n.direction&&(i=-i,r=-r);var a=(i-r)*e;t.style.transform="translateX("+(r+a)+"px)"},s=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=((isNaN(n.max)?30:n.max)-(isNaN(n.min)?0:n.min))*e;t.style.transform="translateY("+-i+"px)"},o=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=isNaN(n.max)?20:n.max,r=isNaN(n.min)?-20:n.min;"left"===n.direction&&(i=-i,r=-r);var a=(i-r)*e;t.style.transform="rotate("+(r+a)+"deg)"},u=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=isNaN(n.max)?1:n.max,r=isNaN(n.max)?0:n.max,a=(i-r)*e;n.reverse?t.style.opacity=i-a:t.style.opacity=r+a},c=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=n.from||[0,0,0],r=n.to||[255,255,255],a=(r[0]-i[0])*e,s=(r[1]-i[1])*e,o=(r[2]-i[2])*e;t.style.backgroundColor="rgb("+Math.floor(r[0]-a)+", "+Math.floor(r[1]-s)+", "+Math.floor(r[2]-o)+")"},h=new(function(){function n(){t(this,n),this.dances={},this.registerDance("size",r),this.registerDance("pulse",r),this.registerDance("shake",a),this.registerDance("jump",s),this.registerDance("twist",o),this.registerDance("vanish",u),this.registerDance("color",c)}return e(n,[{key:"registerDance",value:function(t,e){this.dances[t]=e}},{key:"dance",value:function(t,e,n,i){var r=t;"string"==typeof t&&(r=this.dances[t]||this.dances.pulse);var a=document.getElementsByClassName(e);Array.from(a).forEach(function(t){return r(t,n,i)})}}]),n}());return function e(){var r=this;t(this,e),this.connectExternalAudioElement=function(t){return r.player.connectExternalAudioElement(t)},this.setMusic=function(t){return r.player.setMusic(t)},this.plugMicrophone=function(){return r.player.plugMicrophone()},this.setGain=function(t){return r.player.setGain(t)},this.connectSource=function(t){return r.player.connectSource(t)},this.addRythm=function(t,e,n,i,a){r.rythms.push({elementClass:t,type:e,startValue:n,nbValue:i,options:a})},this.start=function(){r.stopped=!1,r.player.start(),r.analyser.reset(),r.renderRythm()},this.renderRythm=function(){r.stopped||(r.analyser.analyse(),r.rythms.forEach(function(t){var e=t.type,n=t.elementClass,i=t.nbValue,a=t.startValue,s=t.options;r.dancer.dance(e,n,r.analyser.getRangeAverageRatio(a,i),s)}),requestAnimationFrame(r.renderRythm))},this.stop=function(){r.stopped=!0,r.player.stop()},this.player=i,this.analyser=n,this.maxValueHistory=n.maxValueHistory,this.dancer=h,this.rythms=[],this.addRythm("rythm-bass","pulse",0,10),this.addRythm("rythm-medium","pulse",150,40),this.addRythm("rythm-high","pulse",400,200)}});